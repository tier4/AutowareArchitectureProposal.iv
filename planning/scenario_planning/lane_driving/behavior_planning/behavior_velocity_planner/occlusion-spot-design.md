## Occlusion Spot

### Role

This module plans safe velocity to slow down before reaching collision point that hidden object is darting out from `occlusion spot` where driver can't see clearly because of obstacles.

![brief](./docs/occlusion_spot/occlusion_spot.svg)

### Activation Timing

This module is activated when the ego-lane has a private/public attribute.

### Limitation

`point cloud` vs `occupancy grid` vs `object detection`

このモジュールでは`occupancy grid` と `object detection`の情報を使用している。安全を担保するために point cloud の生の情報を利用する方法もあるが、その点群が草なのか、落ち葉なのか、柱なのか、信号待ちの車両によるものなのかの判定がつかない。そこでこのモジュールでは Occupancy Grid を用いて死角と判定する際に死角の大きさ、死角と自分のレーンとの間に専有グリッドがないかどうかなどの判定を入れている。これによって死角の誤検知は減った。しかしながら植え込みや柵の形状などによっては OccupancyGrid の生成がうまく行かないシーンもありその場合は不要な減速が入ってしまうこともある。こちらは OccupancyGrid の改善が課題となっている。また、公道では信号待ちの車両や、渋滞しているレーンにいる車両など人が飛び出てくるとは考えづらいシーンで減速をかけないために、減速対象の死角を作成する車両が路駐しているのかどうかなど判定をいれている。

`point cloud` vs `occupancy grid` vs `object detection`.

This module uses information from `occupancy grid` and `object detection`. There is a way to use the raw information of point cloud to ensure safety, but it is not possible to determine whether the point cloud is grass, leaves, pillars, or a vehicle waiting at a traffic light. Therefore, this module uses Occupancy Grid to determine the size of the occlusion spot and whether or not there is a proprietary grid between the occlusion spot and the user's lane. This has reduced the number of false occlusion spot detections. However, there are some scenes where OccupancyGrid generation does not work properly due to the shape of planted trees or fences, and in such cases, unnecessary deceleration may occur. Improving the Occupancy Grid is an issue that needs to be addressed. Also, on public roads, in order to avoid slowing down in scenes where it is difficult to imagine people jumping out, such as when a vehicle is waiting at a traffic light or in a congested lane, a judgment is made as to whether or not the vehicle creating the occlusion spot for slowing down is parked on the road.

### Inner-workings / Algorithms

#### Logics Working In Private/Public Load

Deceleration for the occlusion spot works on **different logic** depending on whether the driving road is **public or private**.

There are several types of occlusions, such as "occlusions generated by parked vehicles" and "occlusions caused by obstructions". In situations such as driving on **private roads**, where people jump out of the way frequently, all possible occlusion spots must be taken into account. Therefore, on private roads, the deceleration plan considers all occlusion spots calculated from the **occupancy grid**. On the other hand, while driving at high speeds, it is not reasonable to take into account all occlusion spots (e.g., jumping out from behind a guardrail). Therefore, on **public roads**, the target of the deceleration calculation is currently limited to only the occlusion spots generated by vehicles parked on the road shoulder, which uses the **dynamic object** information.

Note that this decision logic is still under development and needs to be improved.

#### Occlusion Spot Public

This module inserts safe velocity at the collision point estimated from the associated occlusion spot under assumption that the pedestrian possibly coming out of the occlusion spot.
![brief](./docs/occlusion_spot/possible_collision_info.svg)

This module consider 3 policies that are very important for risk predicting system for occlusion spot.

1. "Passable" without deceleration (Not implemented yet)
   If ego vehicle speed is high enough to pass the occlusion spot and expected to have no collision with any objects coming out of the occlusion spot, then it's possible for ego vehicle to pass the spot without deceleration.

2. "Predictable" with enough distance to occlusion
   If ego vehicle has enough distance to the occlusion spot, then ego vehicle is going to slow down to the speed that is slow enough to stop before collision with full brake.
   If ego vehicle pass the possible collision point, then ego vehicle is going to drive normally.

3. "Unavoidable" without enough distance to occlusion spot
   This module assumes the occlusion spot is detected stably far from the ego vehicle. Therefore this module can not guarantee the safety behavior for the occlusion spot detected suddenly in front of the ego vehicle. In this case, slow velocity that does not cause the strong deceleration is only applied.

#### Occlusion Spot Private

This module considers any occlusion spot around ego path computed from the occupancy grid.

![occupancy_grid](./docs/occlusion_spot/occupancy_grid.svg)

Occlusion spot computation: searching occlusion spots for all cells in the occupancy_grid inside "focus range" requires a lot of computational cost, so this module will stop searching if the first occlusion spot is found in the following searching process.

![brief](./docs/occlusion_spot/sidewalk_slice.svg)

Note that the accuracy and performance of this search method is limited due to the approximation.

#### Module Parameters

| Parameter            | Type   | Description                                                               |
| -------------------- | ------ | ------------------------------------------------------------------------- |
| `pedestrian_vel`     | double | [m/s] maximum velocity assumed pedestrian coming out from occlusion point |
| `safety_time_buffer` | double | [m/s] time buffer for the system delay                                    |

| Parameter /threshold    | Type   | Description                                               |
| ----------------------- | ------ | --------------------------------------------------------- |
| `detection_area_length` | double | [m] the length of path to consider occlusion spot         |
| `stuck_vehicle_vel`     | double | [m/s] velocity below this value is assumed to stop        |
| `lateral_distance`      | double | [m] maximum lateral distance to consider hidden collision |

| Parameter /(public or private)\_road | Type   | Description                                                          |
| ------------------------------------ | ------ | -------------------------------------------------------------------- |
| `min_velocity`                       | double | [m/s] minimum velocity to ignore occlusion spot                      |
| `ebs_decel`                          | double | [m/s^2] maximum deceleration to assume for emergency braking system. |
| `pbs_decel`                          | double | [m/s^2] deceleration to assume for predictive braking system         |

| Parameter /sidewalk       | Type   | Description                                                     |
| ------------------------- | ------ | --------------------------------------------------------------- |
| `min_occlusion_spot_size` | double | [m] the length of path to consider occlusion spot               |
| `focus_range`             | double | [m] buffer around the ego path used to build the sidewalk area. |

| Parameter /grid  | Type   | Description                                                     |
| ---------------- | ------ | --------------------------------------------------------------- |
| `free_space_max` | double | [-] maximum value of a free space cell in the occupancy grid    |
| `occupied_min`   | double | [-] buffer around the ego path used to build the sidewalk area. |

#### Flowchart

##### Rough overview of the whole process

```plantuml
@startuml
title modifyPathVelocity (Private/Public) Road
start

:get current road type;

if (road type is PUBLIC) then (yes)
  :preprocess dynamic object;
else if (road type is PRIVATE) then (yes)
  :preprocess occupancy grid map info;
else (no)
  stop
endif

:generate possible collision;

:find possible collision between path and occlusion spot;

if (possible collision is found?) then (yes)
else (no)
  stop
endif

:calculate collision path point;

:calculate safe velocity consider lateral distance and safe velocity;

:insertSafeVelocityToPath;

stop
@enduml
```

##### Detail process for public road

```plantuml
@startuml
title modifyPathVelocity For Public Road
start
partition parking_vehicle_selection {
:get all lanelet id on ego path;
:get right/left lanelets around ego path;
:get center lane lines from lanelets around ego path;
:get parked vehicle from dynamic object array;
note right
  target parked vehicle is define as follow .
  - dynamic object's semantic type is "car","bus","track".
  - velocity is below `stuck_vehicle_vel`.
  - lateral position from lane center is farther than `lateral_deviation_threshold`.
end note
}
partition offset_calculation {
:interpolate ego path;
note right
  using spline interpolation and interpolate (x,y,z,v)
end note
:get closest index from ego position in interpolated path;
:calculate offset from path start to ego;
}
:convert interpolated path to `path_lanelet`;
note right
  `path_lanelet` is lanelet which is created by ego path
    and mainly used for arc coordinate conversion.
end note
partition generate_possible_collision {
:generate possible collision behind parked vehicle;
note right
  - occlusion spot candidate is stuck vehicle polygon 2 points farther which is closer to ego path.
  - consider occlusion which is nearer than `lateral_distance_threshold`.
end note
:calculate collision path point and intersection point;
note right
  - occlusion spot is calculated by stuck vehicle polygon.
  - intersection point is where ego front bumper and darting object will crash.
  - collision path point is calculated by arc coordinate consider ego vehicle's geometry.
end note
}
:extract target road type start/end distance by arc length;
:calculate original velocity and height for the possible collision;
note right
calculated (x,y,z,v) at the path using linear interpolation between interpolated path points.
end note
partition calculate_safe_velocity {
:calculate safe velocity consider lateral distance and safe velocity;
note right
calculated by
- ebs deceleration [m/s] emergency braking system consider lateral distance to the occlusion spot.
- pbs deceleration [m/s] predictive braking system consider distance to the possible collision.
- min velocity [m/s] the velocity that is allowed on the road.
- original_velocity [m/s]
end note
}
:insert safe velocity to path;
note right
 set minimum velocity for path point after occlusion spot.
end note
stop
@enduml
```

##### Detail process for private road

```plantuml
@startuml
title modifyPathVelocity For Private Road
start
partition occupancy_grid_preprocess {
:convert occupancy grid to image;
note right
  convert from occupancy grid to image to use opencv functions.
end note
:remove noise from occupancy to apply dilate and erode;
note right
  applying dilate and erode is much better and faster than rule base noise reduction.
end note
:quantize image to categorize to free_space,unknown,occupied;
:convert image to occupancy grid;
note right
  convert from occupancy grid to image to use opencv functions.
end note
}
partition offset_calculation {
:interpolate ego path;
note right
  using spline interpolation and interpolate (x,y,z,v)
end note
:get closest index from ego position in interpolated path;
:calculate offset from path start to ego;
}
:convert interpolated path to `path_lanelet`;
note right
  `path_lanelet` is lanelet which is created by ego path
    and mainly used for arc coordinate conversion.
end note
partition generate_possible_collision {
:generate possible collision from occlusion spot;
note right
  - occlusion spot candidate is N by N size unknown cells.
  - consider occlusion which is nearer than `lateral_distance_threshold`.
end note
:calculate collision path point and intersection point;
note right
  - occlusion spot is calculated by longitudinally closest point of unknown cells.
  - intersection point is where ego front bumper and darting object will crash.
  - collision path point is calculated by arc coordinate consider ego vehicle's geometry.
end note
}
:extract target road type start/end distance by arc length;
:calculate original velocity and height for the possible collision;
note right
calculated (x,y,z,v) at the path using linear interpolation between interpolated path points.
end note
partition calculate_safe_velocity {
:calculate safe velocity consider lateral distance and safe velocity;
note right
calculated by
- ebs deceleration [m/s] emergency braking system consider lateral distance to the occlusion spot.
- pbs deceleration [m/s] predictive braking system consider distance to the possible collision.
- min velocity [m/s] the velocity that is allowed on the road.
- original_velocity [m/s]
end note
}
:insert safe velocity to path;
note right
 set minimum velocity for path point after occlusion spot.
end note
stop
@enduml
```
